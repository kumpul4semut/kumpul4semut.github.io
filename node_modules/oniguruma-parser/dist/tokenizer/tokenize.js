"use strict";import{cpOf as h,PosixClassNames as N,r as c,throwIfNullish as S}from"../utils.js";const m=c`\[\^?`,b=`c.? | C(?:-.?)?|${c`[pP]\{(?:\^?[-\x20_]*[A-Za-z][-\x20\w]*\})?`}|${c`x[89A-Fa-f]\p{AHex}(?:\\x[89A-Fa-f]\p{AHex})*`}|${c`u(?:\p{AHex}{4})? | x\{[^\}]*\}? | x\p{AHex}{0,2}`}|${c`o\{[^\}]*\}?`}|${c`\d{1,3}`}`,y=/[?*+][?+]?|\{(?:\d+(?:,\d*)?|,\d+)\}\??/,C=new RegExp(c`
  \\ (?:
    ${b}
    | [gk]<[^>]*>?
    | [gk]'[^']*'?
    | .
  )
  | \( (?:
    \? (?:
      [:=!>({]
      | <[=!]
      | <[^>]*>
      | '[^']*'
      | ~\|?
      | #(?:[^)\\]|\\.?)*
      | [^:)]*[:)]
    )?
    | \*[^\)]*\)?
  )?
  | (?:${y.source})+
  | ${m}
  | .
`.replace(/\s+/g,""),"gsu"),T=new RegExp(c`
  \\ (?:
    ${b}
    | .
  )
  | \[:(?:\^?\p{Alpha}+|\^):\]
  | ${m}
  | &&
  | .
`.replace(/\s+/g,""),"gsu");function M(e,t={}){const n={flags:"",...t,rules:{captureGroup:!1,singleline:!1,...t.rules}};if(typeof e!="string")throw new Error("String expected as pattern");const a=Y(n.flags),s=[a.extended],o={captureGroup:n.rules.captureGroup,getCurrentModX(){return s.at(-1)},numOpenGroups:0,popModX(){s.pop()},pushModX(u){s.push(u)},replaceCurrentModX(u){s[s.length-1]=u},singleline:n.rules.singleline};let r=[],i;for(C.lastIndex=0;i=C.exec(e);){const u=F(o,e,i[0],C.lastIndex);u.tokens?r.push(...u.tokens):u.token&&r.push(u.token),u.lastIndex!==void 0&&(C.lastIndex=u.lastIndex)}const l=[];let p=0;r.filter(u=>u.type==="GroupOpen").forEach(u=>{u.kind==="capturing"?u.number=++p:u.raw==="("&&l.push(u)}),p||l.forEach((u,G)=>{u.kind="capturing",u.number=G+1});const k=p||l.length;return{tokens:r.map(u=>u.type==="EscapedNumber"?ee(u,k):u).flat(),flags:a}}function F(e,t,n,a){const[s,o]=n;if(n==="["||n==="[^"){const r=K(t,n,a);return{tokens:r.tokens,lastIndex:r.lastIndex}}if(s==="\\"){if("AbBGyYzZ".includes(o))return{token:w(n,n)};if(/^\\g[<']/.test(n)){if(!/^\\g(?:<[^>]+>|'[^']+')$/.test(n))throw new Error(`Invalid group name "${n}"`);return{token:_(n)}}if(/^\\k[<']/.test(n)){if(!/^\\k(?:<[^>]+>|'[^']+')$/.test(n))throw new Error(`Invalid group name "${n}"`);return{token:A(n)}}if(o==="K")return{token:I("keep",n)};if(o==="N"||o==="R")return{token:f("newline",n,{negate:o==="N"})};if(o==="O")return{token:f("any",n)};if(o==="X")return{token:f("grapheme",n)};const r=x(n,{inCharClass:!1});return Array.isArray(r)?{tokens:r}:{token:r}}if(s==="("){if(o==="*")return{token:j(n)};if(n==="(?{")throw new Error(`Unsupported callout "${n}"`);if(n.startsWith("(?#")){if(t[a]!==")")throw new Error('Unclosed comment group "(?#"');return{lastIndex:a+1}}if(/^\(\?[-imx]+[:)]$/.test(n))return{token:L(n,e)};if(e.pushModX(e.getCurrentModX()),e.numOpenGroups++,n==="("&&!e.captureGroup||n==="(?:")return{token:g("group",n)};if(n==="(?>")return{token:g("atomic",n)};if(n==="(?="||n==="(?!"||n==="(?<="||n==="(?<!")return{token:g(n[2]==="<"?"lookbehind":"lookahead",n,{negate:n.endsWith("!")})};if(n==="("&&e.captureGroup||n.startsWith("(?<")&&n.endsWith(">")||n.startsWith("(?'")&&n.endsWith("'"))return{token:g("capturing",n,{...n!=="("&&{name:n.slice(3,-1)}})};if(n.startsWith("(?~")){if(n==="(?~|")throw new Error(`Unsupported absence function kind "${n}"`);return{token:g("absence_repeater",n)}}throw n==="(?("?new Error(`Unsupported conditional "${n}"`):new Error(`Invalid or unsupported group option "${n}"`)}if(n===")"){if(e.popModX(),e.numOpenGroups--,e.numOpenGroups<0)throw new Error('Unmatched ")"');return{token:Q(n)}}if(e.getCurrentModX()){if(n==="#"){const r=t.indexOf(`
`,a);return{lastIndex:r===-1?t.length:r}}if(/^\s$/.test(n)){const r=/\s+/y;return r.lastIndex=a,{lastIndex:r.exec(t)?r.lastIndex:a}}}if(n===".")return{token:f("dot",n)};if(n==="^"||n==="$"){const r=e.singleline?{"^":c`\A`,$:c`\Z`}[n]:n;return{token:w(r,n)}}return n==="|"?{token:P(n)}:y.test(n)?{tokens:ne(n)}:{token:d(h(n),n)}}function K(e,t,n){const a=[E(t[1]==="^",t)];let s=1,o;for(T.lastIndex=n;o=T.exec(e);){const r=o[0];if(r[0]==="["&&r[1]!==":")s++,a.push(E(r[1]==="^",r));else if(r==="]"){if(a.at(-1).type==="CharacterClassOpen")a.push(d(93,r));else if(s--,a.push(z(r)),!s)break}else{const i=X(r);Array.isArray(i)?a.push(...i):a.push(i)}}return{tokens:a,lastIndex:T.lastIndex||e.length}}function X(e){if(e[0]==="\\")return x(e,{inCharClass:!0});if(e[0]==="["){const t=/\[:(?<negate>\^?)(?<name>[a-z]+):\]/.exec(e);if(!t||!N.has(t.groups.name))throw new Error(`Invalid POSIX class "${e}"`);return f("posix",e,{value:t.groups.name,negate:!!t.groups.negate})}return e==="-"?U(e):e==="&&"?H(e):d(h(e),e)}function x(e,{inCharClass:t}){const n=e[1];if(n==="c"||n==="C")return Z(e);if("dDhHsSwW".includes(n))return q(e);if(e.startsWith(c`\o{`))throw new Error(`Incomplete, invalid, or unsupported octal code point "${e}"`);if(/^\\[pP]\{/.test(e)){if(e.length===3)throw new Error(`Incomplete or invalid Unicode property "${e}"`);return V(e)}if(/^\\x[89A-Fa-f]\p{AHex}/u.test(e))try{const a=e.split(/\\x/).slice(1).map(i=>parseInt(i,16)),s=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}).decode(new Uint8Array(a)),o=new TextEncoder;return[...s].map(i=>{const l=[...o.encode(i)].map(p=>`\\x${p.toString(16)}`).join("");return d(h(i),l)})}catch{throw new Error(`Multibyte code "${e}" incomplete or invalid in Oniguruma`)}if(n==="u"||n==="x")return d(J(e),e);if($.has(n))return d($.get(n),e);if(/\d/.test(n))return W(t,e);if(e==="\\")throw new Error(c`Incomplete escape "\"`);if(n==="M")throw new Error(`Unsupported meta "${e}"`);if([...e].length===2)return d(e.codePointAt(1),e);throw new Error(`Unexpected escape "${e}"`)}function P(e){return{type:"Alternator",raw:e}}function w(e,t){return{type:"Assertion",kind:e,raw:t}}function A(e){return{type:"Backreference",raw:e}}function d(e,t){return{type:"Character",value:e,raw:t}}function z(e){return{type:"CharacterClassClose",raw:e}}function U(e){return{type:"CharacterClassHyphen",raw:e}}function H(e){return{type:"CharacterClassIntersector",raw:e}}function E(e,t){return{type:"CharacterClassOpen",negate:e,raw:t}}function f(e,t,n={}){return{type:"CharacterSet",kind:e,...n,raw:t}}function I(e,t,n={}){return e==="keep"?{type:"Directive",kind:e,raw:t}:{type:"Directive",kind:e,flags:S(n.flags),raw:t}}function W(e,t){return{type:"EscapedNumber",inCharClass:e,raw:t}}function Q(e){return{type:"GroupClose",raw:e}}function g(e,t,n={}){return{type:"GroupOpen",kind:e,...n,raw:t}}function D(e,t,n,a){return{type:"NamedCallout",kind:e,tag:t,arguments:n,raw:a}}function R(e,t,n,a){return{type:"Quantifier",kind:e,min:t,max:n,raw:a}}function _(e){return{type:"Subroutine",raw:e}}const B=new Set(["COUNT","CMP","ERROR","FAIL","MAX","MISMATCH","SKIP","TOTAL_COUNT"]),$=new Map([["a",7],["b",8],["e",27],["f",12],["n",10],["r",13],["t",9],["v",11]]);function Z(e){const t=e[1]==="c"?e[2]:e[3];if(!t||!/[A-Za-z]/.test(t))throw new Error(`Unsupported control character "${e}"`);return d(h(t.toUpperCase())-64,e)}function L(e,t){let{on:n,off:a}=/^\(\?(?<on>[imx]*)(?:-(?<off>[-imx]*))?/.exec(e).groups;a??="";const s=(t.getCurrentModX()||n.includes("x"))&&!a.includes("x"),o=v(n),r=v(a),i={};if(o&&(i.enable=o),r&&(i.disable=r),e.endsWith(")"))return t.replaceCurrentModX(s),I("flags",e,{flags:i});if(e.endsWith(":"))return t.pushModX(s),t.numOpenGroups++,g("group",e,{...(o||r)&&{flags:i}});throw new Error(`Unexpected flag modifier "${e}"`)}function j(e){const t=/\(\*(?<name>[A-Za-z_]\w*)?(?:\[(?<tag>(?:[A-Za-z_]\w*)?)\])?(?:\{(?<args>[^}]*)\})?\)/.exec(e);if(!t)throw new Error(`Incomplete or invalid named callout "${e}"`);const{name:n,tag:a,args:s}=t.groups;if(!n)throw new Error(`Invalid named callout "${e}"`);if(a==="")throw new Error(`Named callout tag with empty value not allowed "${e}"`);const o=s?s.split(",").filter(k=>k!=="").map(k=>/^[+-]?\d+$/.test(k)?+k:k):[],[r,i,l]=o,p=B.has(n)?n.toLowerCase():"custom";switch(p){case"fail":case"mismatch":case"skip":if(o.length>0)throw new Error(`Named callout arguments not allowed "${o}"`);break;case"error":if(o.length>1)throw new Error(`Named callout allows only one argument "${o}"`);if(typeof r=="string")throw new Error(`Named callout argument must be a number "${r}"`);break;case"max":if(!o.length||o.length>2)throw new Error(`Named callout must have one or two arguments "${o}"`);if(typeof r=="string"&&!/^[A-Za-z_]\w*$/.test(r))throw new Error(`Named callout argument one must be a tag or number "${r}"`);if(o.length===2&&(typeof i=="number"||!/^[<>X]$/.test(i)))throw new Error(`Named callout optional argument two must be '<', '>', or 'X' "${i}"`);break;case"count":case"total_count":if(o.length>1)throw new Error(`Named callout allows only one argument "${o}"`);if(o.length===1&&(typeof r=="number"||!/^[<>X]$/.test(r)))throw new Error(`Named callout optional argument must be '<', '>', or 'X' "${r}"`);break;case"cmp":if(o.length!==3)throw new Error(`Named callout must have three arguments "${o}"`);if(typeof r=="string"&&!/^[A-Za-z_]\w*$/.test(r))throw new Error(`Named callout argument one must be a tag or number "${r}"`);if(typeof i=="number"||!/^(?:[<>!=]=|[<>])$/.test(i))throw new Error(`Named callout argument two must be '==', '!=', '>', '<', '>=', or '<=' "${i}"`);if(typeof l=="string"&&!/^[A-Za-z_]\w*$/.test(l))throw new Error(`Named callout argument three must be a tag or number "${l}"`);break;case"custom":throw new Error(`Undefined callout name "${n}"`);default:throw new Error(`Unexpected named callout kind "${p}"`)}return D(p,a??null,s?.split(",")??null,e)}function O(e){let t=null,n,a;if(e[0]==="{"){const{minStr:s,maxStr:o}=/^\{(?<minStr>\d*)(?:,(?<maxStr>\d*))?/.exec(e).groups,r=1e5;if(+s>r||o&&+o>r)throw new Error("Quantifier value unsupported in Oniguruma");if(n=+s,a=o===void 0?+s:o===""?1/0:+o,n>a&&(t="possessive",[n,a]=[a,n]),e.endsWith("?")){if(t==="possessive")throw new Error('Unsupported possessive interval quantifier chain with "?"');t="lazy"}else t||(t="greedy")}else n=e[0]==="+"?1:0,a=e[0]==="?"?1:1/0,t=e[1]==="+"?"possessive":e[1]==="?"?"lazy":"greedy";return R(t,n,a,e)}function q(e){const t=e[1].toLowerCase();return f({d:"digit",h:"hex",s:"space",w:"word"}[t],e,{negate:e[1]!==t})}function V(e){const{p:t,neg:n,value:a}=/^\\(?<p>[pP])\{(?<neg>\^?)(?<value>[^}]+)/.exec(e).groups;return f("property",e,{value:a,negate:t==="P"&&!n||t==="p"&&!!n})}function v(e){const t={};return e.includes("i")&&(t.ignoreCase=!0),e.includes("m")&&(t.dotAll=!0),e.includes("x")&&(t.extended=!0),Object.keys(t).length?t:null}function Y(e){if(!/^[imxDPSW]*$/.test(e))throw new Error(`Flags "${e}" includes unsupported value`);const t={ignoreCase:!1,dotAll:!1,extended:!1,digitIsAscii:!1,posixIsAscii:!1,spaceIsAscii:!1,wordIsAscii:!1};for(const n of e)t[{i:"ignoreCase",m:"dotAll",x:"extended",D:"digitIsAscii",P:"posixIsAscii",S:"spaceIsAscii",W:"wordIsAscii"}[n]]=!0;return t}function J(e){if(/^(?:\\u(?!\p{AHex}{4})|\\x(?!\p{AHex}{1,2}|\{\p{AHex}{1,8}\}))/u.test(e))throw new Error(`Incomplete or invalid escape "${e}"`);const t=e[2]==="{"?/^\\x\{\s*(?<hex>\p{AHex}+)/u.exec(e).groups.hex:e.slice(2);return parseInt(t,16)}function ee(e,t){const{raw:n,inCharClass:a}=e,s=n.slice(1);if(!a&&(s!=="0"&&s.length===1||s[0]!=="0"&&+s<=t))return[A(n)];const o=[],r=s.match(/^[0-7]+|\d/g);for(let i=0;i<r.length;i++){const l=r[i];let p;if(i===0&&l!=="8"&&l!=="9"){if(p=parseInt(l,8),p>127)throw new Error(c`Octal encoded byte above 177 unsupported "${n}"`)}else p=h(l);o.push(d(p,(i===0?"\\":"")+l))}return o}function ne(e){const t=[],n=new RegExp(y,"gy");let a;for(;a=n.exec(e);){const s=a[0];if(s[0]==="{"){const o=/^\{(?<min>\d+),(?<max>\d+)\}\??$/.exec(s);if(o){const{min:r,max:i}=o.groups;if(+r>+i&&s.endsWith("?")){n.lastIndex--,t.push(O(s.slice(0,-1)));continue}}}t.push(O(s))}return t}export{M as tokenize};
//# sourceMappingURL=tokenize.js.map
